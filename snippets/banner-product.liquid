

{%- assign current_product = product | default: null -%}
{%- if current_product == null and handle -%}
  {%- assign current_product = all_products[handle] -%}
{%- endif -%}

{%- if current_product == null -%}
  <div class="bp bp--error" style="padding:1rem;border:1px dashed #ddd;border-radius:.75rem">
    {{ 'product.banner.missing_product' | t | default: 'Failed to load product: please pass product or handle.' }}
  </div>
{%- else -%}

  {%- assign featured_img = current_product.featured_image -%}
  {%- assign title_safe = current_product.title | escape -%}

  {%- comment -%} find color option index {%- endcomment -%}
  {%- assign color_index = 0 -%}
  {%- for opt in current_product.options_with_values -%}
    {%- assign opt_name = opt.name | downcase -%}
    {%- if opt_name == 'color' or opt_name == 'colour' or opt_name == 'цвет' or opt_name == 'kolor' -%}
      {%- assign color_index = forloop.index -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if color_index == 0 and current_product.options.size > 0 -%}
    {%- assign color_index = 1 -%}
  {%- endif -%}

  {%- if color_index == 0 -%}
    <div class="bp">
      <div class="bp__head"><strong>{{ title_safe }}</strong></div>
      <div class="bp__body" style="margin-top:.5rem">
        {{ 'product.banner.no_color_option' | t | default: 'No Color option found for this product. Palette not shown.' }}
      </div>
    </div>
  {%- else -%}

    {%- case color_index -%}
      {%- when 1 -%}{%- assign colors_all = current_product.variants | map: 'option1' -%}
      {%- when 2 -%}{%- assign colors_all = current_product.variants | map: 'option2' -%}
      {%- when 3 -%}{%- assign colors_all = current_product.variants | map: 'option3' -%}
    {%- endcase -%}
    {%- assign colors_uniq = colors_all | uniq -%}

    {%- assign main_variant = current_product.selected_or_first_available_variant | default: current_product.variants.first -%}

    {%- capture price_block -%}
      {%- if main_variant and main_variant.price -%}
        <div class="bp__price">
          {%- if main_variant.compare_at_price and main_variant.compare_at_price > main_variant.price -%}
            <span class="bp__price--new">{{ main_variant.price | money_without_trailing_zeros }}</span>
            <s class="bp__price--old" aria-label="{{ 'product.banner.old_price' | t | default: 'Old price' }}">
              {{ main_variant.compare_at_price | money_without_trailing_zeros }}
            </s>
          {%- else -%}
            <span class="bp__price--regular">{{ main_variant.price | money_without_trailing_zeros }}</span>
          {%- endif -%}
        </div>
      {%- endif -%}
    {%- endcapture -%}

    {%- assign vendor_down = current_product.vendor | downcase -%}
    {%- capture vendor_badge -%}
      {%- case vendor_down -%}
        {%- when 'nike','adidas' -%}
          <span class="bp__badge">{{ 'product.banner.badge.top_brand' | t | default: 'Highly Rated' }}</span>
      {%- endcase -%}
    {%- endcapture -%}

    {%- assign variants = current_product.variants -%}

    <div class="bp" data-product-id="{{ current_product.id }}">
      <!-- media column -->
      <div class="bp__media">
        <div class="bp__thumbs">
          {%- if current_product.images.size > 1 -%}
            {%- for img in current_product.images -%}
              {%- if forloop.index0 == 0 -%}{%- continue -%}{%- endif -%}
              {%- if forloop.index > 4 -%}{%- break -%}{%- endif -%}
              <button
                type="button"
                class="bp__thumb"
                data-image="{{ img | image_url: width: 1100 }}"
                aria-label="{{ 'product.banner.switch_image' | t | default: 'Switch image' }}"
              >
                {{ img | image_url: width: 200 | image_tag: loading: 'lazy', alt: img.alt | default: title_safe }}
              </button>
            {%- endfor -%}
          {%- endif -%}
        </div>

        {%- if featured_img -%}
          {{ featured_img | image_url: width: 1100 | image_tag: loading: 'lazy', alt: featured_img.alt | default: title_safe }}
        {%- else -%}
          {{ 'image' | placeholder_svg_tag }}
        {%- endif -%}
      </div>

      <!-- content column -->
      <div class="bp__content">
        <div class="bp__top">
          <h3 class="bp__title">{{ title_safe }}</h3>
          {{- vendor_badge -}}
        </div>

        {{- price_block -}}

        <div class="bp__colors">
          <div class="bp__label">{{ 'product.banner.select_color' | t | default: 'Select color' }}</div>

          <div class="bp__swatches" role="list">
            {%- assign printed = 0 -%}
            {%- for color in colors_uniq -%}
              {%- if color == blank -%}{%- continue -%}{%- endif -%}

              {%- case color_index -%}
                {%- when 1 -%}{%- assign matched = variants | where: 'option1', color -%}
                {%- when 2 -%}{%- assign matched = variants | where: 'option2', color -%}
                {%- when 3 -%}{%- assign matched = variants | where: 'option3', color -%}
              {%- endcase -%}
              {%- assign v = matched.first -%}
              {%- if v == null -%}{%- continue -%}{%- endif -%}

              {%- assign qty = v.inventory_quantity | default: 0 -%}

{%- assign inv_tracked = false -%}
{%- if v.inventory_management -%}
  {%- assign inv_tracked = true -%}
{%- endif -%}

{%- assign available_f = v.available -%}

{%- assign is_unavailable = false -%}
{%- if inv_tracked and qty == 0 -%}
  {%- assign is_unavailable = true -%}
{%- elsif inv_tracked == false and available_f == false -%}
  {%- assign is_unavailable = true -%}
{%- endif -%}


              <button
                type="button"
                role="listitem"
                class="bp__swatch{% if is_unavailable %} is-disabled{% endif %}"
                data-variant-id="{{ v.id }}"
                data-qty="{{ qty }}"
                data-available="{{ available_f }}"
                data-inv-tracked="{{ inv_tracked }}"
                data-image="{{ v.image | default: featured_img | image_url: width: 1100 }}"
                data-color="{{ color | escape }}"
                aria-label="{{ color | escape }}"
              >
                <span class="bp__swatch-dot" aria-hidden="true"></span>
                <span class="bp__swatch-label" style="position:absolute;left:-9999px">{{ color | escape }}</span>
              </button>

              {%- assign printed = printed | plus: 1 -%}
              {%- if printed >= 3 -%}{%- break -%}{%- endif -%}
            {%- endfor -%}
          </div>

          <div class="bp__stock" data-stock>
            {{ 'product.banner.select_color' | t | default: 'Select color' }}
          </div>
        </div>

        {%- if main_variant -%}
          <div class="bp__cta">
            <a
              href="{{ routes.cart_add_url }}?id={{ main_variant.id }}&quantity=1"
              class="bp__add"
            >
              {{ 'product.banner.add_to_cart' | t | default: 'Add to cart' }}
            </a>
          </div>
        {%- endif -%}
      </div>
    </div>

    <style>
      /* Card */
      .bp{
        display:grid;
        grid-template-columns: 560px 1fr;
        gap:32px;
        align-items:start;
        background:#fff;
        border:1px solid #eee;
        border-radius:16px;
        padding:24px;
      }

      /* Media: thumbs left, big image right */
      .bp__media{
        display:grid;
        grid-template-columns: 96px 1fr;
        gap:16px;
      }
      .bp__media > img{
        grid-column:2;
        width:100%;
        height:auto;
        display:block;
        border-radius:12px;
        background:#f6f6f6;
      }
      .bp__thumbs{ grid-column:1; display:flex; flex-direction:column; gap:12px; }
      .bp__thumb{
        border:1px solid #eee; border-radius:10px; padding:0; background:#fff; cursor:pointer;
        width:96px; height:72px; display:block; overflow:hidden;
      }
      .bp__thumb img{ width:100%; height:100%; object-fit:cover; display:block; border-radius:8px; }

      /* Title & price */
      .bp__title{ margin:0 0 8px; font-size:36px; line-height:1.2; font-weight:600; }
      .bp__price{ display:flex; gap:12px; align-items:baseline; margin:4px 0 16px; }
      .bp__price--new,.bp__price--regular{ font-weight:700; font-size:20px; }
      .bp__price--old{ opacity:.55; }

      /* Badge (optional) */
      .bp__badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#eef; font-size:12px; }

      /* Swatches */
      .bp__label{ font-size:14px; margin:8px 0 8px; color:#666; }
      .bp__swatches{ display:flex; gap:12px; flex-wrap:wrap; }
      .bp__swatch{ min-width:36px; height:36px; border-radius:999px; border:1px solid #ccc; display:inline-flex; align-items:center; justify-content:center; background:#fff; position:relative; cursor:pointer; transition:box-shadow .15s; }
      .bp__swatch-dot{ width:24px; height:24px; border-radius:999px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.08); background:var(--c,#f3f3f3); display:block; }
      .bp__swatch.is-active{ outline:2px solid #111; outline-offset:2px; }
      .bp__swatch.is-disabled{ opacity:.45; cursor:not-allowed; }

      /* Stock & CTA */
      .bp__stock{ font-size:14px; color:#333; margin-top:10px; min-height:20px; }
      .bp__cta{ margin-top:20px; }
      .bp__add{ display:inline-flex; align-items:center; justify-content:center; width:100%; height:56px; background:#111; color:#fff; border-radius:10px; padding:0 20px; text-decoration:none; font-weight:600; }

      /* Color helpers */
      .bp__swatch[data-color*="black" i] .bp__swatch-dot{ --c:#000; }
      .bp__swatch[data-color*="white" i] .bp__swatch-dot{ --c:#fff; }
      .bp__swatch[data-color*="red"   i] .bp__swatch-dot{ --c:#e11; }
      .bp__swatch[data-color*="blue"  i] .bp__swatch-dot{ --c:#39f; }
      .bp__swatch[data-color*="green" i] .bp__swatch-dot{ --c:#3c6; }
      .bp__swatch[data-color*="beige" i] .bp__swatch-dot{ --c:#e6d8c3; }
      .bp__swatch[data-color*="grey" i],
      .bp__swatch[data-color*="gray" i] .bp__swatch-dot{ --c:#bbb; }

      /* Responsive */
      @media (max-width: 1024px){
        .bp{ grid-template-columns: 1fr; }
        .bp__media{ grid-template-columns: 84px 1fr; }
      }
      @media (max-width: 640px){
        .bp__title{ font-size:28px; }
      }
    </style>

    <script>
      (function(){
        var root = document.currentScript.closest('.bp');
        if(!root) return;

        var stockEl  = root.querySelector('[data-stock]');
        var mainImg  = root.querySelector('.bp__media img');
        var swatches = root.querySelectorAll('.bp__swatch');

        function setActive(btn){
          swatches.forEach(function(b){ b.classList.remove('is-active'); });
          btn.classList.add('is-active');
        }

        function updateStock(btn){
          var qty        = parseInt(btn.dataset.qty, 10);
          var available  = (btn.dataset.available === 'true');
          var invTracked = (btn.dataset.invTracked === 'true');

          var notAvailableText   = {{ "product.banner.not_available"        | t | default: "Not available"        | json }};
          var availableWithCount = {{ "product.banner.available_with_count" | t | default: "Available: __count__" | json }};
          var availableGeneric   = {{ "product.banner.available"            | t | default: "In stock"              | json }};

          var text = '';
          if(invTracked){
            if(isNaN(qty) || qty <= 0){ text = notAvailableText; }
            else { text = availableWithCount.replace('__count__', qty); }
          } else {
            text = available ? availableGeneric : notAvailableText;
          }
          stockEl.textContent = text;
        }

        function switchImage(btn){
          var src = btn.dataset.image;
          if(mainImg && src){ mainImg.src = src; }
        }

        swatches.forEach(function(btn){
          btn.addEventListener('click', function(){
            if(btn.classList.contains('is-disabled')) return;
            setActive(btn);
            updateStock(btn);
            switchImage(btn);
          });
        });

        // Thumbnails click
        root.querySelectorAll('.bp__thumb').forEach(function(th){
          th.addEventListener('click', function(){
            var src = th.getAttribute('data-image');
            if(mainImg && src){ mainImg.src = src; }
          });
        });

        // Preselect first swatch
        if(swatches[0]){ swatches[0].click(); }
      })();
    </script>

  {%- endif -%}
{%- endif -%}
