<div class="orphaned-content">
  This content will never be displayed
</div>
{%- assign current_product = product | default: null -%}
{%- if current_product == null and handle -%}
  {%- assign current_product = all_products[handle] -%}
{%- endif -%}

{%- if current_product == null -%}
  <div class="bp bp--error" style="padding:1rem;border:1px dashed #ddd;border-radius:.75rem">
    {{ 'products.banner.missing_product' | t | default: 'Failed to load product: please pass product or handle.' }}
  </div>
{%- else -%}

{%- assign featured_img = current_product.featured_image -%}
{%- assign title_safe = current_product.title | escape -%}

/* ---- find option indexes: color & size ---- */
{%- assign color_index = 0 -%}
{%- assign size_index  = 0 -%}
{%- for opt in current_product.options_with_values -%}
  {%- assign n = opt.name | downcase -%}
  {%- if n == 'color' or n == 'colour' or n == 'цвет' or n == 'kolor' -%}
    {%- assign color_index = forloop.index -%}
  {%- elsif n == 'size' or n == 'rozmiar' or n == 'размер' -%}
    {%- assign size_index = forloop.index -%}
  {%- endif -%}
{%- endfor -%}
{%- if color_index == 0 and current_product.options.size > 0 -%}{%- assign color_index = 1 -%}{%- endif -%}

/* ---- if no color option at all ---- */
{%- if color_index == 0 -%}
  <div class="bp">
    <div class="bp__head"><strong>{{ title_safe }}</strong></div>
    <div class="bp__body" style="margin-top:.5rem">
      {{ 'products.banner.no_color_option' | t | default: 'No Color option found for this product. Palette not shown.' }}
    </div>
  </div>
{%- else -%}

/* ---- collect unique colors ---- */
{%- case color_index -%}
  {%- when 1 -%}{%- assign colors_all = current_product.variants | map: 'option1' -%}
  {%- when 2 -%}{%- assign colors_all = current_product.variants | map: 'option2' -%}
  {%- when 3 -%}{%- assign colors_all = current_product.variants | map: 'option3' -%}
{%- endcase -%}
{%- assign colors_uniq = colors_all | uniq -%}

/* ---- main variant and price block ---- */
{%- assign main_variant = current_product.selected_or_first_available_variant | default: current_product.variants.first -%}
{%- capture price_block -%}
  {%- if main_variant and main_variant.price -%}
    <div class="bp__price">
      {%- if main_variant.compare_at_price and main_variant.compare_at_price > main_variant.price -%}
        <span class="bp__price--new">{{ main_variant.price | money_without_trailing_zeros }}</span>
        <s class="bp__price--old" aria-label="{{ 'products.banner.old_price' | t | default: 'Old price' }}">{{ main_variant.compare_at_price | money_without_trailing_zeros }}</s>
      {%- else -%}
        <span class="bp__price--regular">{{ main_variant.price | money_without_trailing_zeros }}</span>
      {%- endif -%}
    </div>
  {%- endif -%}
{%- endcapture -%}

{%- assign variants = current_product.variants -%}

<div class="bp" data-product-id="{{ current_product.id }}">
  <div class="bp__media">
    {%- if featured_img -%}
      {{ featured_img | image_url: width: 900 | image_tag: loading: 'lazy', alt: featured_img.alt | default: title_safe }}
    {%- else -%}
      {{ 'image' | placeholder_svg_tag: 'bp__placeholder' }}
    {%- endif -%}

    {%- if current_product.images.size > 1 -%}
      <div class="bp__thumbs">
        {%- for img in current_product.images limit:3 -%}
          <button type="button" class="bp__thumb" data-image="{{ img | image_url: width: 900 }}">
            {{ img | image_url: width: 96 | image_tag: loading: 'lazy', alt: img.alt | default: title_safe }}
          </button>
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>

  <div class="bp__content">
    <div class="bp__top">
      <h3 class="bp__title">{{ title_safe }}</h3>
    </div>

    {{- price_block -}}

    <!-- COLORS (thumbnails with images) -->
    <div class="bp__colors">
      <div class="bp__label">{{ 'products.banner.select_color' | t | default: 'Select color' }}</div>
      <div class="bp__swatches" role="list">
        {%- assign printed = 0 -%}
        {%- for color in colors_uniq -%}
          {%- if color == blank -%}{%- continue -%}{%- endif -%}

          {%- comment -%} all variants for this color {%- endcomment -%}
          {%- case color_index -%}
            {%- when 1 -%}{%- assign color_variants = variants | where: 'option1', color -%}
            {%- when 2 -%}{%- assign color_variants = variants | where: 'option2', color -%}
            {%- when 3 -%}{%- assign color_variants = variants | where: 'option3', color -%}
          {%- endcase -%}

          {%- assign v = color_variants.first -%}
          {%- if v == null -%}{%- continue -%}{%- endif -%}

          {%- assign hero_image = v.image | default: featured_img -%}

          {%- comment -%}
            build sizes JSON for this color (if size option exists)
          {%- endcomment -%}
          {%- capture sizes_json -%}
            [
            {%- if size_index > 0 -%}
              {%- for vv in color_variants -%}
                {%- case size_index -%}
                  {%- when 1 -%}{%- assign size_label = vv.option1 -%}
                  {%- when 2 -%}{%- assign size_label = vv.option2 -%}
                  {%- when 3 -%}{%- assign size_label = vv.option3 -%}
                {%- endcase -%}
                {
                  "id": {{ vv.id }},
                  "label": {{ size_label | json }},
                  "qty": {{ vv.inventory_quantity | default: 0 }},
                  "available": {{ vv.available | json }},
                  "invTracked": {{ vv.inventory_management | json }},
                  "image": {{ (vv.image | default: hero_image) | image_url: width: 900 | json }}
                }{%- if forloop.last == false -%},{%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            ]
          {%- endcapture -%}

          <button
            type="button"
            role="listitem"
            class="bp__swatch bp__swatch--thumb"
            data-variant-id="{{ v.id }}"
            data-image="{{ hero_image | image_url: width: 900 }}"
            data-sizes='{{ sizes_json | strip | escape }}'
            aria-label="{{ color | escape }}"
            title="{{ color | escape }}"
          >
            {%- if hero_image -%}
              {{ hero_image | image_url: width: 72 | image_tag: loading: 'lazy', alt: color }}
            {%- else -%}
              <span class="bp__swatch-dot" aria-hidden="true"></span>
            {%- endif -%}
            <span class="bp__swatch-label">{{ color | escape }}</span>
          </button>

          {%- assign printed = printed | plus: 1 -%}
          {%- if printed >= 3 -%}{%- break -%}{%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    <!-- STOCK LINE -->
    <div class="bp__stock" data-stock>{{ 'products.banner.select_color' | t | default: 'Select color' }}</div>

    <!-- SIZES (dynamic, per color) -->
    <div class="bp__sizes" data-sizes hidden>
      <div class="bp__label">{{ 'products.banner.select_size' | t | default: 'Select size' }}</div>
      <div class="bp__sizes-list"></div>
    </div>

    <!-- CTA -->
    {%- if main_variant -%}
      <div class="bp__cta">
        <a href="{{ routes.bag_add_url }}?id={{ main_variant.id }}&quantity=1" class="bp__add">
          {{ 'products.banner.add_to_bag' | t | default: 'Add to bag' }}
        </a>
      </div>
    {%- endif -%}
  </div>
</div>

<style>
/* layout */
.bp{display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start;border:1px solid #eee;border-radius:16px;padding:16px;background:#fff}
@media (max-width: 860px){.bp{grid-template-columns:1fr}}

/* media */
.bp__media img{display:block;width:100%;height:auto;border-radius:12px;background:#f6f6f6}
.bp__thumbs{display:flex;gap:8px;margin-top:12px}
.bp__thumb{border:1px solid #eee;border-radius:10px;padding:0;background:#fff;cursor:pointer}
.bp__thumb img{display:block;border-radius:8px}

/* title & price */
.bp__title{margin:0 0 4px;font-size:24px;line-height:1.25;font-weight:600}
.bp__price{display:flex;gap:8px;align-items:baseline;margin:6px 0 8px}
.bp__price--new,.bp__price--regular{font-weight:700;font-size:18px}
.bp__price--old{opacity:.6}

/* swatches (as thumbnails) */
.bp__label{font-size:14px;margin:8px 0 6px;color:#666}
.bp__swatches{display:flex;gap:10px;flex-wrap:wrap}
.bp__swatch{position:relative;cursor:pointer;transition:box-shadow .15s}
.bp__swatch--thumb{border:1px solid #ccc;border-radius:10px;padding:2px;background:#fff}
.bp__swatch--thumb img{display:block;width:72px;height:72px;object-fit:cover;border-radius:8px}
.bp__swatch.is-active{outline:2px solid #111;outline-offset:2px}
.bp__swatch-label{position:absolute;left:-9999px}

/* sizes */
.bp__sizes{margin-top:6px}
.bp__sizes-list{display:flex;gap:8px;flex-wrap:wrap}
.bp__size{min-width:72px;padding:.5rem .75rem;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
.bp__size.is-active{border-color:#111;box-shadow:0 0 0 2px #111 inset}
.bp__size.is-disabled{opacity:.45;cursor:not-allowed}

/* stock + CTA */
.bp__stock{font-size:14px;color:#333;margin-top:6px;min-height:20px}
.bp__cta{margin-top:10px}
.bp__add{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;background:#111;color:#fff;border-radius:10px;padding:.7rem 1.1rem;text-decoration:none;font-weight:600}
</style>

<script>
(function(){
  var root = document.currentScript.closest('.bp');
  if(!root) return;

  var mainImg   = root.querySelector('.bp__media img');
  var stockEl   = root.querySelector('[data-stock]');
  var swatches  = root.querySelectorAll('.bp__swatch');
  var addBtn    = root.querySelector('.bp__add');
  var sizesWrap = root.querySelector('[data-sizes]');
  var sizesList = root.querySelector('.bp__sizes-list');

  function setActive(list, btn){
    list.forEach(function(b){ b.classList.remove('is-active'); });
    btn.classList.add('is-active');
  }

  function updateStockFromData(qty, available, invTracked){
    var notAvailableText   = {{ "products.banner.not_available"        | t | default: "Not available" | json }};
    var availableWithCount = {{ "products.banner.available_with_count" | t | default: "Available: __count__" | json }};
    var availableGeneric   = {{ "products.banner.available"            | t | default: "Available" | json }};
    var text = '';
    if(invTracked){
      if(isNaN(qty) || qty <= 0){ text = notAvailableText; }
      else { text = availableWithCount.replace('__count__', qty); }
    } else {
      text = (available === true || available === 'true') ? availableGeneric : notAvailableText;
    }
    stockEl.textContent = text;
  }

  function renderSizes(btn){
    // parse sizes JSON from data-sizes (array of {id,label,qty,available,invTracked,image})
    var sizes = [];
    try { sizes = JSON.parse(btn.dataset.sizes || '[]'); } catch(e){}
    sizesList.innerHTML = '';
    sizesWrap.hidden = (sizes.length === 0);

    if(sizes.length === 0){
      // if нет размеров — делаем ссылку на вариант цвета
      if(addBtn && btn.dataset.variantId){
        addBtn.href = '{{ routes.bag_add_url }}?id=' + btn.dataset.variantId + '&quantity=1';
      }
      return;
    }

    sizes.forEach(function(s){
      var b = document.createElement('button');
      b.type = 'button';
      b.className = 'bp__size';
      b.textContent = s.label;
      b.dataset.variantId = s.id;
      b.dataset.qty = String(s.qty || 0);
      b.dataset.available = String(s.available);
      b.dataset.invTracked = String(!!s.invTracked);
      b.dataset.image = s.image || '';

      if((s.invTracked && (!s.qty || s.qty <= 0)) || (s.invTracked === null && s.available === false)){
        b.disabled = true;
        b.classList.add('is-disabled');
      }

      b.addEventListener('click', function(){
        setActive(sizesList.querySelectorAll('.bp__size'), b);
        // stock text
        updateStockFromData(parseInt(b.dataset.qty,10), (b.dataset.available === 'true'), (b.dataset.invTracked === 'true'));
        // image
        if(mainImg && b.dataset.image){ mainImg.src = b.dataset.image; }
        // add-to-cart link
        if(addBtn){ addBtn.href = '{{ routes.bag_add_url }}?id=' + b.dataset.variantId + '&quantity=1'; }
      });

      sizesList.appendChild(b);
    });
  }

  
  swatches.forEach(function(btn){
    btn.addEventListener('click', function(){
      setActive(swatches, btn);
      var img = btn.getAttribute('data-image');
      if(mainImg && img){ mainImg.src = img; }
      renderSizes(btn);
      stockEl.textContent = {{ "products.banner.select_size" | t | default: "Select size" | json }};
    });
  });

  // thumbs below hero
  root.querySelectorAll('.bp__thumb').forEach(function(th){
    th.addEventListener('click', function(){
      var src = th.getAttribute('data-image');
      if(mainImg && src){ mainImg.src = src; }
    });
  });

  // auto-choose first color
  if(swatches[0]){ swatches[0].click(); }
})();
</script>

{%- endif -%} {# color_index check #}
{%- endif -%} {# product exists #}
