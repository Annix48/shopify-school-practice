{% comment %}
  Universal product banner
  Usage:
    {% render 'banner-product', handle: 'nike-air-max-plus' %}
    or (inside loops)
    {% render 'banner-product', product: product %}
{% endcomment %}

{%- assign current_product = product | default: null -%}
{%- if current_product == null and handle -%}
  {%- assign current_product = all_products[handle] -%}
{%- endif -%}

{%- if current_product == null -%}
  <div class="bp bp--error" style="padding:1rem;border:1px dashed #ddd;border-radius:.75rem">
    {{ 'products.banner.missing_product' | t | default: 'Failed to load product: please pass product or handle.' }}
  </div>
{%- else -%}
  {%- assign featured_image = current_product.featured_image -%}
  {%- assign title_safe = current_product.title | escape -%}
  {%- assign hero_alt = featured_image.alt | default: title_safe -%}

  {%- comment %} ---- find option indexes: color & size ---- {%- endcomment %}
  {%- assign color_index = 0 -%}
  {%- assign size_index = 0 -%}
  {%- for opt in current_product.options_with_values -%}
    {%- assign n = opt.name | downcase -%}
    {%- if n == 'color' or n == 'colour' or n == 'цвет' or n == 'kolor' -%}
      {%- assign color_index = forloop.index -%}
    {%- elsif n == 'size' or n == 'rozmiar' or n == 'размер' -%}
      {%- assign size_index = forloop.index -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if color_index == 0 and current_product.options.size > 0 -%}{%- assign color_index = 1 -%}{%- endif -%}

  {%- if color_index == 0 -%}
    <div class="bp">
      <div class="bp__head">
        <strong>{{ title_safe }}</strong>
      </div>
      <div class="bp__body" style="margin-top:.5rem">
        {{
          'products.banner.no_color_option'
          | t
          | default: 'No Color option found for this product. Palette not shown.'
        }}
      </div>
    </div>
  {%- else -%}
    {%- case color_index -%}
      {%- when 1 -%}
        {%- assign colors_all = current_product.variants | map: 'option1' -%}
      {%- when 2 -%}
        {%- assign colors_all = current_product.variants | map: 'option2' -%}
      {%- when 3 -%}
        {%- assign colors_all = current_product.variants | map: 'option3' -%}
    {%- endcase -%}
    {%- assign colors_uniq = colors_all | uniq -%}

    {%- comment %} ---- main variant & price block ---- {%- endcomment %}
    {%- assign main_variant = current_product.selected_or_first_available_variant
      | default: current_product.variants.first
    -%}
    {%- capture price_block -%}
  {%- if main_variant and main_variant.price -%}
    <div class="bp__price">
      {%- if main_variant.compare_at_price and main_variant.compare_at_price > main_variant.price -%}
        <span class="bp__price--new">{{ main_variant.price | money_without_trailing_zeros }}</span>
        <s class="bp__price--old" aria-label="{{ 'products.banner.old_price' | t | default: 'Old price' }}">
          {{ main_variant.compare_at_price | money_without_trailing_zeros }}
        </s>
      {%- else -%}
        <span class="bp__price--regular">{{ main_variant.price | money_without_trailing_zeros }}</span>
      {%- endif -%}
    </div>
  {%- endif -%}
{%- endcapture -%}

    {%- assign variants = current_product.variants -%}

    <div class="bp" data-product-id="{{ current_product.id }}">
      {%- comment %} LEFT: media with vertical thumbs {%- endcomment %}
      <div class="bp__media">
        {%- if current_product.images.size > 1 -%}
          <div class="bp__thumbs">
            {%- for img in current_product.images -%}
              <button type="button" class="bp__thumb" data-image="{{ img | image_url: width: 1200 }}">
                {{ img | image_url: width: 120 | image_tag: loading: 'lazy', alt: img.alt | default: title_safe }}
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}

        <div class="bp__hero">
          {%- if featured_image -%}
            {{ featured_image | image_url: width: 1400 | image_tag: loading: 'lazy', alt: hero_alt }}
          {%- else -%}
            {{ 'image' | placeholder_svg_tag: 'bp__placeholder' }}
          {%- endif -%}
          <div class="bp__chip">
            <span class="bp__chip-dot">★</span>
            {{ 'Highly Rated' }}
          </div>
        </div>
      </div>

      {%- comment %} RIGHT: content {%- endcomment %}
      <div class="bp__content">
        <h1 class="bp__title">{{ title_safe }}</h1>
        {{- price_block -}}

        {%- comment %} COLORS (thumbnails with images) {%- endcomment %}
        <div class="bp__colors">
          <div class="bp__swatches" role="list">
            {%- assign printed = 0 -%}
            {%- for color in colors_uniq -%}
              {%- if color == blank -%}{%- continue -%}{%- endif -%}

              {%- case color_index -%}
                {%- when 1 -%}
                  {%- assign color_variants = variants | where: 'option1', color -%}
                {%- when 2 -%}
                  {%- assign color_variants = variants | where: 'option2', color -%}
                {%- when 3 -%}
                  {%- assign color_variants = variants | where: 'option3', color -%}
              {%- endcase -%}

              {%- assign v = color_variants.first -%}
              {%- if v == null -%}{%- continue -%}{%- endif -%}

              {%- assign hero_image = v.image -%}
              {%- if hero_image == blank -%}
                {%- assign color_key = color | downcase -%}
                {%- for img in current_product.images -%}
                  {%- assign alt_lc = img.alt | downcase -%}
                  {%- if alt_lc contains color_key -%}
                    {%- assign hero_image = img -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
              {%- assign hero_image = hero_image | default: featured_image -%}

              {%- assign hero_image = v.image | default: featured_image -%}

              {%- assign unique_urls = '' | split: '' -%}
              {%- for vv in color_variants -%}
                {%- if vv.image -%}
                  {%- assign full = vv.image | image_url: width: 1200 -%}
                  {%- unless unique_urls contains full -%}
                    {%- assign unique_urls = unique_urls | concat: [full] -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endfor -%}

              {%- capture gallery_json -%}
[
{%- for u in unique_urls limit: 3 -%}
  {{ u | json }}{%- unless forloop.last -%},{%- endunless -%}
{%- endfor -%}
]
{%- endcapture -%}
              <button
                type="button"
                role="listitem"
                class="bp__swatch bp__swatch--thumb"
                data-variant-id="{{ v.id }}"
                data-image="{{ hero_image | image_url: width: 1200 }}"
                data-gallery="{{ gallery_json | strip | escape }}"
                aria-label="{{ color | escape }}"
                title="{{ color | escape }}"
              >
                {{ hero_image | image_url: width: 180 | image_tag: loading: 'lazy', alt: color }}
                <span class="bp__swatch-label">{{ color | escape }}</span>
              </button>
              {%- assign printed = printed | plus: 1 -%}
              {%- if printed >= 3 -%}{%- break -%}{%- endif -%}
              {%- capture gallery_thumbs_json -%}
[
{%- for u in unique_urls limit: 3 -%}
  {{ u | replace: 'width=1200','width=120' | json }}{%- unless forloop.last -%},{%- endunless -%}
{%- endfor -%}
]
{%- endcapture -%}

              {%- capture gallery_thumbs_json -%}
          [
          {%- assign printed_th = 0 -%}
          {%- for vv in color_variants -%}
            {%- if vv.image -%}
              {{ vv.image | image_url: width: 120 | json }}
              {%- assign printed_th = printed_th | plus: 1 -%}
              {%- if printed_th < 3 -%},{%- endif -%}
              {%- if printed_th >= 3 -%}{%- break -%}{%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          ]
          {%- endcapture -%}

              {%- capture sizes_json -%}
            [
            {%- if size_index > 0 -%}
              {%- for vv in color_variants -%}
                {%- case size_index -%}
                  {%- when 1 -%}{%- assign size_label = vv.option1 -%}
                  {%- when 2 -%}{%- assign size_label = vv.option2 -%}
                  {%- when 3 -%}{%- assign size_label = vv.option3 -%}
                {%- endcase -%}
                {
                  "id": {{ vv.id }},
                  "label": {{ size_label | json }},
                  "qty": {{ vv.inventory_quantity | default: 0 }},
                  "available": {{ vv.available | json }},
                  "invTracked": {% if vv.inventory_management %}true{% else %}false{% endif %},
                  "image": {{ vv.image | default: featured_image | image_url: width: 1200 | json }}
                }{%- if forloop.last == false -%},{%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            ]
          {%- endcapture -%}

              <button
                type="button"
                role="listitem"
                class="bp__swatch bp__swatch--thumb"
                data-variant-id="{{ v.id }}"
                data-image="{{ hero_image | image_url: width: 1200 }}"
                data-gallery="{{ gallery_json | strip | escape }}"
                data-gallery-thumbs="{{ gallery_thumbs_json | strip | escape }}"
                data-sizes="{{ sizes_json | strip | escape }}"
                aria-label="{{ color | escape }}"
                title="{{ color | escape }}"
              >
                {%- if hero_image -%}
                  {{ hero_image | image_url: width: 180 | image_tag: loading: 'lazy', alt: color }}
                {%- else -%}
                  <span class="bp__swatch-dot" aria-hidden="true"></span>
                {%- endif -%}
                <span class="bp__swatch-label">{{ color | escape }}</span>
              </button>

              {%- assign printed = printed | plus: 1 -%}
              {%- if printed >= 3 -%}{%- break -%}{%- endif -%}
            {%- endfor -%}
          </div>
        </div>

        {%- comment %} STOCK LINE {%- endcomment %}
        <div class="bp__label bp__label--spaced">Select Size:</div>

        {%- comment %} SIZES (mock buttons to match figma layout) {%- endcomment %}
        <div class="bp__sizes" data-sizes>
          <div class="bp__sizes-list">
            <button type="button" class="bp__size">UK 5.5</button>
            <button type="button" class="bp__size">UK 6 (EU 39)</button>
            <button type="button" class="bp__size">UK 6 (EU 40)</button>
            <button type="button" class="bp__size">UK 6.5</button>
            <button type="button" class="bp__size">UK 7</button>
            <button type="button" class="bp__size">UK 7.5</button>
          </div>
        </div>

        {%- if main_variant -%}
          <a href="{{ routes.cart_add_url }}?id={{ main_variant.id }}&quantity=1" class="bp__add">
            {{ 'products.banner.add_to_bag' | t | default: 'Add To Bag' }}
          </a>
        {%- endif -%}

        <p class="bp__note">
          Let your attitude have the edge in your Nike Air Max Plus, a Tuned Air experience that offers premium
          stability and unbelievable cushioning.
        </p>
      </div>
    </div>

    <style>
      /* ===== Layout ===== */
      .bp{
        --bp-radius: 16px;
        --bp-border: #eee;
        --bp-muted: #666;
        --bp-black: #111;
        --bp-bg-soft: #f5f5f5;

        display:grid;
        grid-template-columns: 680px 1fr;
        gap: 48px;
        padding: 28px;
        background:#fff;
        border:1px solid var(--bp-border);
        border-radius: var(--bp-radius);
      }
      @media (max-width: 1400px){ .bp{ grid-template-columns: 620px 1fr; } }
      @media (max-width: 1250px){ .bp{ grid-template-columns: 580px 1fr; } }
      @media (max-width: 1100px){
        .bp{ grid-template-columns: 1fr; gap: 28px; }
      }

      /* ===== Media area (thumbs left, hero right) ===== */
      .bp__media{
        display:grid;
        grid-template-columns: 120px 1fr;
        gap: 24px;
        align-items:start;
      }
      .bp__thumbs{
        display:flex;
        flex-direction:column;
        gap:18px;
        max-height: 620px;
        overflow:auto;
        padding-right:2px;
      }
      .bp__thumb{
        display:block;
        padding:0;
        border:1px solid var(--bp-border);
        border-radius:12px;
        background:#fff;
        cursor:pointer;
        transition:box-shadow .15s, border-color .15s;
      }
      .bp__thumb img{ display:block; border-radius:10px; }
      .bp__thumb:focus-visible{ outline:2px solid var(--bp-black); outline-offset:2px; }

      .bp__thumbs::-webkit-scrollbar { width:0; height:0; }
      .bp__thumbs{ scrollbar-width: none; -ms-overflow-style: none; }

      .bp__hero{
        position:relative;
        background:#f3f3f3;
        border-radius:14px;
        min-height: 560px;
        padding:16px;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .bp__hero img{
        max-width:100%;
        height:auto;
        object-fit: contain;
        display:block;
        border-radius:12px;
        background:#f3f3f3;
      }
      .bp__chip{
        position:absolute;
        left:16px;
        top:16px;
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border-radius:10px;
        background:#fff;
         border:1px solid var(--bp-border);
        font-size:14px;
      }
      .bp__chip-dot{ font-size:14px; }

      /* ===== Title & price ===== */
      .bp__title{ margin:0 0 8px; font-size:30px; line-height:1.2; font-weight:400; }
      .bp__price{ display:flex; gap:10px; align-items:baseline; margin:6px 0 18px; }
      .bp__price--new,.bp__price--regular{ font-weight:400; font-size:16px; }
      .bp__price--old{ opacity:.55; }

      /* ===== Labels ===== */
      .bp__label{ font-size:14px; color:var(--bp-muted); margin:4px 0 8px; }
      .bp__label--spaced{ margin-top:18px; }

      /* ===== Color swatches (as mini-cards) ===== */
      .bp__swatches{ display:flex; gap:12px; flex-wrap:wrap; }
      .bp__swatch{ position:relative; cursor:pointer; }
      .bp__swatch--thumb{
        border:1px solid #ccc; border-radius:12px; background:#fff; padding:6px;
        transition:border-color .15s, box-shadow .15s, transform .05s;
      }
      .bp__swatch--thumb:hover{ box-shadow:0 0 0 2px var(--bp-black) inset; transform:translateY(-1px); }
      .bp__swatch--thumb img{ display:block; width:84px; height:84px; object-fit:cover; border-radius:10px; }
      .bp__swatch.is-active{ outline:2px solid var(--bp-black); outline-offset:3px; }
      .bp__swatch-label{ position:absolute; left:-9999px; }

      /* ===== Sizes ===== */
      .bp__sizes{ margin-top:10px; }
      .bp__sizes-list{ display:grid; grid-template-columns: repeat(3, minmax(160px,1fr)); gap:14px; }
      @media (max-width: 600px){ .bp__sizes-list{ grid-template-columns: repeat(2, minmax(140px,1fr)); } }
      .bp__size{
        min-height:56px; padding:.8rem 1.2rem; border:1px solid #ddd; border-radius:12px;
        background:#fff; cursor:pointer; font-weight:500;
        transition: box-shadow .15s, border-color .15s, transform .05s;
      }
      .bp__size:hover{ border-color:var(--bp-black); box-shadow:0 0 0 1px var(--bp-black) inset; }
      .bp__size.is-active{ border-color:var(--bp-black); box-shadow:0 0 0 2px var(--bp-black) inset; }
      .bp__size.is-disabled{ opacity:.45; cursor:not-allowed; }

      /* ===== Stock line ===== */
      .bp__stock{ min-height:22px; font-size:14px; color:#333; }

      /* ===== CTA ===== */
      .bp__add{
        display:block; width:100%; text-align:center; margin-top:18px;
        background:var(--bp-black); color:#fff; text-decoration:none;
        padding:1rem 1.2rem; border-radius:12px; font-weight:700; font-size:16px;
        transition: filter .15s, transform .05s;
      }
      .bp__add:hover{ filter:brightness(.92); }
      .bp__add:active{ transform:translateY(1px); }

      /* ===== Note ===== */
      .bp__note{ margin-top:16px; color:#555; line-height:1.6; }
    </style>

    <script>
      (function(){
        var root = document.currentScript.closest('.bp');
        if(!root) return;

        var mainImg   = root.querySelector('.bp__hero img');
        var stockEl   = root.querySelector('[data-stock]');
        var swatches  = root.querySelectorAll('.bp__swatch');
        var addBtn    = root.querySelector('.bp__add');
        var sizesWrap = root.querySelector('[data-sizes]');
        var sizesList = root.querySelector('.bp__sizes-list');
        var thumbsWrap= root.querySelector('.bp__thumbs');

        function setActive(list, btn){
          list.forEach(function(b){ b.classList.remove('is-active'); });
          btn.classList.add('is-active');
        }

        function updateStockFromData(qty, available, invTracked){
          var notAvailableText   = {{ "products.banner.not_available"        | t | default: "Not available" | json }};
          var availableWithCount = {{ "products.banner.available_with_count" | t | default: "Available: __count__" | json }};
          var availableGeneric   = {{ "products.banner.available"            | t | default: "Available" | json }};
          var text = '';
          if(invTracked){
            if(isNaN(qty) || qty <= 0){ text = notAvailableText; }
            else { text = availableWithCount.replace('__count__', qty); }
          } else {
            text = (available === true || available === 'true') ? availableGeneric : notAvailableText;
          }
          if (stockEl) stockEl.textContent = text;
        }

        function renderThumbs(urls){
          if(!thumbsWrap) return;
          thumbsWrap.innerHTML = '';
          (urls || []).forEach(function(src){
            var b = document.createElement('button');
            b.type = 'button';
            b.className = 'bp__thumb';
            b.setAttribute('data-image', src);
            b.innerHTML = '<img alt="" loading="lazy" src="'+ src.replace('width=1200','width=120') +'">';
            b.addEventListener('click', function(){
              if(mainImg){ mainImg.src = src; }
            });
            thumbsWrap.appendChild(b);
          });
        }

        function renderSizes(btn){
          var sizes = [];
          try { sizes = JSON.parse(btn.dataset.sizes || '[]'); } catch(e){}
          sizesList.innerHTML = '';
          sizesWrap.hidden = (sizes.length === 0);

          if(sizes.length === 0){
            if(addBtn && btn.dataset.variantId){
              addBtn.href = '{{ routes.cart_add_url }}?id=' + btn.dataset.variantId + '&quantity=1';
            }
            return;
          }

          sizes.forEach(function(s){
            var b = document.createElement('button');
            b.type = 'button';
            b.className = 'bp__size';
            b.textContent = s.label;
            b.dataset.variantId = s.id;
            b.dataset.qty = String(s.qty || 0);
            b.dataset.available = String(!!s.available);
            b.dataset.invTracked = String(!!s.invTracked);
            b.dataset.image = s.image || '';

            if((s.invTracked && (!s.qty || s.qty <= 0)) || (!s.invTracked && s.available === false)){
              b.disabled = true;
              b.classList.add('is-disabled');
            }

            b.addEventListener('click', function(){
              setActive(sizesList.querySelectorAll('.bp__size'), b);
              updateStockFromData(parseInt(b.dataset.qty,10), (b.dataset.available === 'true'), (b.dataset.invTracked === 'true'));
              if(mainImg && b.dataset.image){ mainImg.src = b.dataset.image; }
              if(addBtn){ addBtn.href = '{{ routes.cart_add_url }}?id=' + b.dataset.variantId + '&quantity=1'; }
            });

            sizesList.appendChild(b);
          });
        }

        // color clicks
        swatches.forEach(function(btn){
          btn.addEventListener('click', function(){
            setActive(swatches, btn);

            // Главное фото
            var img = btn.getAttribute('data-image');
            if(mainImg && img){ mainImg.src = img; }

            // Галерея слева
            var gal = [];
            try { gal = JSON.parse(btn.getAttribute('data-gallery') || '[]'); } catch(e){}
            renderThumbs(gal);

            // Размеры
            renderSizes(btn);

            if (stockEl){
              stockEl.textContent = {{ "products.banner.select_size" | t | default: "Select size" | json }};
            }
          });
        });

        // vertical thumbs (initial)
        root.querySelectorAll('.bp__thumb').forEach(function(th){
          th.addEventListener('click', function(){
            var src = th.getAttribute('data-image');
            if(mainImg && src){ mainImg.src = src; }
          });
        });

        // auto-select first color
        if(swatches[0]){ swatches[0].click(); }
      })();
    </script>
  {%- endif -%}
{%- endif -%}
